# PR-0007 — CLI Integration + Docs Alignment

Status: proposed

## Summary
- Integrate a production-ready CLI that mirrors the web app’s Refine/Reinforce operations.
- Align learning documentation with existing repo docs; preserve contracts and invariants.
- Harden error handling and logging for `/api/refine` and Ollama client.

## Changes
- CLI
  - Added `bin/promptpad.cjs` executable (uses `tsx`) and `lib/cli/*` TypeScript sources.
  - Commands: `refine <input>`, `reinforce <draft>`; global options `--model`, `--temperature`, `--timeout`, `--verbose`.
  - Utilities for clipboard, prompts, validation, version info.
  - Default model `gpt-oss:20b`, temperature clamped to ≤0.3 per invariants.
- API & Libraries
  - `/api/refine`: fixed catch-scope reference for robust error logs when body parsing fails; completed reinforce prompt helper.
  - `lib/ollama`: removed stray `controller.signal` ref; retained soft timeout logging; structured errors.
- Documentation
  - New `docs/CLI.md` with quick start, usage, troubleshooting, and development notes.
  - `README.md` section updates highlighting two-pass workflow and local-first design.
  - `CHANGELOG.md` entries for CLI and logging hardening.

## Verification
Run locally (skip build if time-constrained):

```bash
pnpm install
pnpm typecheck
pnpm lint

# CLI help (optional; requires sandbox permissions for tsx IPC)
node bin/promptpad.cjs --help
```

API contract checks (mock mode):

```bash
export OLLAMA_MOCK=1
node -e "(async () => { const { GET } = await import('./app/api/models/route.ts'); const r=await GET(); console.log(await r.json()); })()"
node -e "(async () => { const { POST } = await import('./app/api/refine/route.ts'); const r=await POST({ json: async () => ({ mode:'refine', input:'x', model:'gpt-oss:20b', temperature:0.2 }) }); console.log(await r.json()); })()"
```

## Risks
- CLI entry uses `tsx`; environments with restricted IPC may prevent running via `node bin/promptpad.cjs` (docs note workarounds).
- Ollama service unavailability: handled via `OLLAMA_MOCK=1` and development fallbacks; production still returns 5xx.

## ADR Links
- Preserved API contract and patch schema from `docs/agents/schemas/*` (no drift).

## DoD
- Typecheck and lint green.
- Routes unchanged: `GET /api/models`, `POST /api/refine` response matches canonical shape (`output`, `usage`, `patch?`).
- CLI documented and aligned with invariants; default model and temperature settings enforced.

